---
phase: 02-core-rotation-infrastructure
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - src/transports/file-transport.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Rotated files are named with date and sequence: app-2026-01-18.log.1, app-2026-01-18.log.2"
    - "Date format uses UTC (YYYY-MM-DD) to avoid timezone issues"
    - "Sequence numbers increment when multiple rotations occur on same day"
    - "File extension is preserved before sequence number"
  artifacts:
    - path: "src/transports/file-transport.ts"
      provides: "generateRotatedName utility function"
      exports: ["generateRotatedName"]
  key_links:
    - from: "generateRotatedName"
      to: "node:fs"
      via: "fs.readdirSync for collision detection"
      pattern: "fs\\.readdirSync"
    - from: "generateRotatedName"
      to: "node:path"
      via: "path parsing and reconstruction"
      pattern: "path\\.(dirname|basename|extname|join)"
---

<objective>
Create rotated filename generator with date-stamping and sequence collision handling.

Purpose: Generate unique rotated filenames using UTC dates and incrementing sequence numbers. This is a pure utility function with no side effects, making it easy to test and verify.

Output: generateRotatedName function that creates filenames like "app-2026-01-18.log.1", "app-2026-01-18.log.2" with automatic sequence incrementing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-core-rotation-infrastructure/02-RESEARCH.md
@.planning/phases/02-core-rotation-infrastructure/02-CONTEXT.md
@.planning/codebase/CONVENTIONS.md
@src/transports/file-transport.ts
@.planning/phases/02-core-rotation-infrastructure/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add generateRotatedName utility function</name>
  <files>src/transports/file-transport.ts</files>
  <action>
    Add generateRotatedName function after the parseSize function (still before the FileTransport class):

    ```typescript
    /**
     * Generate a rotated filename with date stamp and sequence number
     *
     * @param filePath - Original log file path
     * @returns Rotated filename path (e.g., "app-2026-01-18.log.1")
     *
     * @remarks
     * Filename format: `{basename}-{YYYY-MM-DD}.{ext}.{sequence}`
     * - Uses UTC date to avoid timezone issues across servers
     * - Sequence increments for multiple rotations per day
     * - Extension preserved before sequence number
     *
     * @example
     * ```typescript
     * generateRotatedName('./logs/app.log');      // './logs/app-2026-01-18.log.1'
     * generateRotatedName('./logs/app.log');      // './logs/app-2026-01-18.log.2' (if .1 exists)
     * generateRotatedName('./logs/error.txt');    // './logs/error-2026-01-18.txt.1'
     * ```
     */
    function generateRotatedName(filePath: string): string {
        const ext = path.extname(filePath);           // '.log'
        const base = path.basename(filePath, ext);    // 'app'
        const dir = path.dirname(filePath);           // './logs'

        // UTC date format: YYYY-MM-DD
        const date = new Date();
        const dateStr = date.toISOString().split('T')[0];  // '2026-01-18'

        // Find existing rotated files to determine next sequence number
        let sequence = 1;

        try {
            const existingFiles = fs.readdirSync(dir)
                .filter(f => f.startsWith(`${base}-${dateStr}`) && f.endsWith(ext));

            // Extract highest sequence number from existing files
            const maxSequence = existingFiles.reduce((max, file) => {
                // Extract sequence number from filename (format: base-date.ext.N)
                const match = file.match(new RegExp(`^${escapeRegExp(base)}-${escapeRegExp(dateStr)}\\${escapeRegExp(ext)}\\.(\\d+)$`));
                return match ? Math.max(max, parseInt(match[1], 10)) : max;
            }, 0);

            sequence = maxSequence + 1;
        } catch (error) {
            // Directory doesn't exist or can't be read — use sequence 1
            // This is fine, rotation will create directory if needed
        }

        // Format: app-2026-01-18.log.1
        const rotatedName = `${base}-${dateStr}${ext}.${sequence}`;
        return path.join(dir, rotatedName);
    }

    /**
     * Escape special regex characters in a string
     */
    function escapeRegExp(str: string): string {
        return str.replace(/[.*+?^${}()|[\]\\]/g, '\\\\$&');
    }
    ```

    Key implementation details:
    - Uses UTC date via `toISOString().split('T')[0]` for consistent YYYY-MM-DD format
    - Reads directory to find existing rotated files with same date pattern
    - Increments sequence number based on highest existing sequence
    - Gracefully handles directory read errors (defaults to sequence 1)
    - Uses escapeRegExp helper to safely use filenames in regex patterns
    - Follows naming convention from RESEARCH.md: basename-YYYY-MM-DD.ext.N

    Place this function AFTER parseSize and BEFORE the FileTransport class definition.
  </action>
  <verify>grep -q "function generateRotatedName" src/transports/file-transport.ts && grep -q "toISOString" src/transports/file-transport.ts</verify>
  <done>generateRotatedName function exists, creates UTC date-stamped filenames with sequence incrementing</done>
</task>

</tasks>

<verification>
After completing the task:

1. Type checking: `npx tsc --noEmit` — should pass
2. Verify date format: Check that ISO date is split correctly to get YYYY-MM-DD
3. Verify sequence logic: Test that sequence increments when files exist
4. Verify regex safety: Ensure special characters in filenames are escaped

Manual verification (optional):
- Create a test file that calls generateRotatedName with various paths
- Verify output format matches expected pattern
</verification>

<success_criteria>
1. generateRotatedName function exists in file-transport.ts
2. Function generates filenames in format: basename-YYYY-MM-DD.ext.N
3. Date uses UTC (toISOString) for consistency
4. Sequence number auto-increments based on existing files
5. Function gracefully handles directory read errors
6. All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-rotation-infrastructure/02-02-SUMMARY.md`
</output>
