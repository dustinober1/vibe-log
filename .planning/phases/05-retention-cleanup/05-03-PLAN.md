---
phase: 05-retention-cleanup
plan: 03
type: execute
wave: 3
depends_on: [05-01]
files_modified:
  - src/transports/file-transport.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "FileTransport accepts maxFiles and maxAge options"
    - "Both fields must be specified together (validation enforced)"
    - "Options are stored as private fields for cleanup logic"
  artifacts:
    - path: "src/transports/file-transport.ts"
      provides: "FileTransport with retention configuration support"
      contains: "maxFiles, maxAge private fields"
  key_links:
    - from: "FileTransportOptions interface"
      to: "RotationConfig interface"
      via: "Type alignment for consistency"
      pattern: "maxFiles|maxAge"
---

<objective>
Add retention configuration support to FileTransport by extending FileTransportOptions and adding validation.

Purpose: Enable FileTransport to receive and store retention configuration (maxFiles and maxAge) for use in cleanup logic.
Output: FileTransport with maxFiles and maxAge private fields and validation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/05-retention-cleanup/05-CONTEXT.md
@.planning/phases/05-retention-cleanup/05-RESEARCH.md
@src/transports/file-transport.ts
@src/types.ts
@.planning/phases/05-retention-cleanup/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend FileTransportOptions with retention fields</name>
  <files>src/transports/file-transport.ts</files>
  <action>
    Extend the FileTransportOptions interface (lines 79-86) to add retention configuration fields:

    Add these two optional fields after compressionLevel:
    - maxFiles?: number - Maximum number of log files to keep (default: 20)
    - maxAge?: number - Maximum age of log files in days (default: 30)

    Follow existing documentation style (similar to compressionLevel field).
  </action>
  <verify>
    grep -A 15 "interface FileTransportOptions" src/transports/file-transport.ts | grep -E "maxFiles|maxAge"
  </verify>
  <done>
    FileTransportOptions interface includes maxFiles and maxAge fields
    Fields are documented with default values
    Interface structure matches RotationConfig for consistency
  </done>
</task>

<task type="auto">
  <name>Task 2: Add retention private fields to FileTransport class</name>
  <files>src/transports/file-transport.ts</files>
  <action>
    Add two private readonly fields to FileTransport class (after line 101, after compressionLevel field):
    - private readonly maxFiles?: number;
    - private readonly maxAge?: number;

    These fields store the retention configuration for use in cleanup logic.
  </action>
  <verify>
    grep "private readonly maxFiles\|private readonly maxAge" src/transports/file-transport.ts
  </verify>
  <done>
    Private fields added to FileTransport class
    Fields are readonly (set once in constructor)
    Positioned after compressionLevel for logical grouping
  </done>
</task>

<task type="auto">
  <name>Task 3: Parse and validate retention config in constructor</name>
  <files>src/transports/file-transport.ts</files>
  <action>
    In the FileTransport constructor (after line 150, after compressionLevel parsing):

    Add retention config parsing with validation:

    1. Parse maxFiles if provided:
       if (options !== undefined && options.maxFiles !== undefined) {
           const maxFiles = options.maxFiles;
           if (maxFiles < 1) {
               throw new Error(`maxFiles must be at least 1, got ${maxFiles}`);
           }
           this.maxFiles = maxFiles;
       }

    2. Parse maxAge if provided:
       if (options !== undefined && options.maxAge !== undefined) {
           const maxAge = options.maxAge;
           if (maxAge < 1) {
               throw new Error(`maxAge must be at least 1 day, got ${maxAge}`);
           }
           this.maxAge = maxAge;
       }

    3. Validate that BOTH fields are specified together (after both parsing blocks):
       // Retention config requires both maxFiles AND maxAge
       const hasMaxFiles = this.maxFiles !== undefined;
       const hasMaxAge = this.maxAge !== undefined;
       if (hasMaxFiles !== hasMaxAge) {
           throw new Error('Retention config requires both maxFiles AND maxAge to be specified');
       }

    This enforces the requirement from CONTEXT.md: both fields must be specified together.
  </action>
  <verify>
    grep -A 30 "Parse compression level" src/transports/file-transport.ts | grep -E "maxFiles|maxAge|Retention config requires"
  </verify>
  <done>
    Retention config parsed and validated in constructor
    Both fields must be specified together (enforced by validation)
    Validation errors thrown for invalid values (< 1)
    Clear error message if only one field is specified
  </done>
</task>

</tasks>

<verification>
- FileTransportOptions extended with maxFiles and maxAge
- Private fields added to FileTransport class
- Constructor parses and validates retention config
- Both-fields-required validation enforced
- Validation errors thrown with clear messages
- TypeScript compiles without errors
</verification>

<success_criteria>
FileTransport accepts retention configuration (maxFiles and maxAge)
Validation ensures both fields are specified together
Configuration stored as private fields for cleanup logic
Ready for integration with retention cleanup in next plan
</success_criteria>

<output>
After completion, create `.planning/phases/05-retention-cleanup/05-03-SUMMARY.md`
</output>
