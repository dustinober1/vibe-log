---
phase: 05-retention-cleanup
plan: 02
type: tdd
wave: 2
depends_on: [05-01]
files_modified:
  - src/utils/retention.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Retention utility functions parse dates from rotated filenames"
    - "Files are sorted by age (oldest first)"
    - "Cleanup uses AND logic (both maxFiles AND maxAge must be exceeded)"
    - "Current active file is never deleted (safety mechanism)"
    - "Best-effort deletion continues on locked file errors"
  artifacts:
    - path: "src/utils/retention.ts"
      provides: "Retention cleanup utility functions"
      exports: ["parseRotatedDate", "getSortedRotatedFiles", "calculateAgeInDays", "cleanupOldLogs"]
      min_lines: 150
  key_links:
    - from: "src/utils/rotation.ts"
      to: "src/utils/retention.ts"
      via: "escapeRegExp utility function"
      pattern: "escapeRegExp"
    - from: "cleanupOldLogs function"
      to: "fs.promises.unlink"
      via: "async file deletion"
      pattern: "fs.promises.unlink"

---

<objective>
Create retention cleanup utility functions for parsing rotated log filenames, sorting by age, and deleting old logs based on retention policy.

Purpose: Implement core retention cleanup logic with AND policy (both maxFiles AND maxAge must be exceeded) and best-effort deletion.
Output: Retention utility module (src/utils/retention.ts) with date parsing, file sorting, and cleanup functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/05-retention-cleanup/05-CONTEXT.md
@.planning/phases/05-retention-cleanup/05-RESEARCH.md
@src/utils/rotation.ts
@src/utils/compression.ts
</context>

<tasks>

<task type="auto">
  <name>RED: Write failing tests for retention utilities</name>
  <files>src/utils/retention.test.ts</files>
  <action>
    Create test file src/utils/retention.test.ts with failing tests for:

    1. parseRotatedDate function:
       - Valid rotated filename returns correct UTC date
       - Non-rotated filename returns undefined
       - Handles .gz files (strips .gz suffix before parsing)
       - Uses UTC date (no timezone issues)

    2. getSortedRotatedFiles function:
       - Returns array of rotated filenames sorted by date (oldest first)
       - Includes both .gz and uncompressed files
       - Returns empty array if directory doesn't exist
       - Filters out non-rotated files

    3. calculateAgeInDays function:
       - Returns correct age in days for old file
       - Returns 0 for today's file
       - Rounds down (not up)

    4. cleanupOldLogs function:
       - Deletes files that exceed BOTH maxFiles AND maxAge thresholds
       - Does NOT delete files that exceed only one threshold (AND logic)
       - Never deletes all files (protects current active file)
       - Continues on locked file errors (best-effort)
       - Returns deleted count and errors array
       - Logs deletion operations to console

    Use Vitest describe/it/expect pattern. Run with `npm test` to verify all tests fail.
  </action>
  <verify>
    npm test -- src/utils/retention.test.ts 2>&1 | grep -E "(FAIL|passing|failing)"
  </verify>
  <done>
    Test file created with comprehensive coverage of all retention utility functions
    All tests fail (RED state) - functions don't exist yet
    Test file compiles and runs with Vitest
  </done>
</task>

<task type="auto">
  <name>GREEN: Implement retention utility functions</name>
  <files>src/utils/retention.ts</files>
  <action>
    Create src/utils/retention.ts with these functions:

    1. parseRotatedDate(filename, base, ext):
       - Match pattern: base-YYYY-MM-DD.ext.sequence (with optional .gz)
       - Extract YYYY-MM-DD and parse as UTC date
       - Return Date object or undefined if not a rotated file
       - Use UTC date: new Date(dateStr + 'T00:00:00.000Z')
       - Strip .gz suffix before parsing if present

    2. getSortedRotatedFiles(dir, base, ext):
       - Scan directory for rotated files matching pattern
       - Parse dates from filenames using parseRotatedDate
       - Sort by date (oldest first)
       - Return empty array on error (directory doesn't exist)

    3. calculateAgeInDays(date):
       - Calculate age in days using UTC timestamps
       - Round down (Math.floor)
       - Formula: Math.floor((now - date) / (24 * 60 * 60 * 1000))

    4. cleanupOldLogs(dir, base, ext, maxFiles, maxAge):
       - Get sorted rotated files (oldest first)
       - Add 1 for current active file (total files)
       - Safety check: return if total files <= 1
       - For each file:
         * Parse date and calculate age
         * Check if BOTH conditions met: (index >= maxFiles - 1) AND (age > maxAge)
         * If both met: await fs.promises.unlink(filePath)
         * Catch errors: add to errors array, log to console, continue
       - Return { deleted, errors }
       - Log each deletion to console

    Copy escapeRegExp function from rotation.ts (needed for regex escaping).
    Use fs.readdirSync, fs.promises.unlink, path.join, path.dirname, path.basename, path.extname.

    Run tests to verify all pass.
  </action>
  <verify>
    npm test -- src/utils/retention.test.ts 2>&1 | grep -E "passing|failing"
  </verify>
  <done>
    All retention utility functions implemented
    All tests pass (GREEN state)
    Functions match documented behavior from RESEARCH.md
    AND logic enforced (both maxFiles AND maxAge must be exceeded)
    Best-effort deletion with error handling
  </done>
</task>

<task type="auto">
  <name>REFACTOR: Clean up implementation if needed</name>
  <files>src/utils/retention.ts</files>
  <action>
    Review src/utils/retention.ts for obvious improvements:
    - Remove any code duplication
    - Improve readability if needed
    - Ensure consistent error handling
    - Verify all edge cases are handled

    Only refactor if clear improvements exist. If code is clean, skip this task.
    Run tests after refactoring to ensure no regressions.
  </action>
  <verify>
    npm test -- src/utils/retention.test.ts
  </verify>
  <done>
    Code is clean and maintainable
    All tests still pass
    No regressions introduced
  </done>
</task>

</tasks>

<verification>
- All retention utility functions implemented
- Tests cover all functions and edge cases
- AND logic enforced (both conditions must be met)
- Best-effort deletion with error handling
- Current active file protected
- Functions ready for FileTransport integration
</verification>

<success_criteria>
Retention utility module created with comprehensive test coverage
Functions parse rotated filenames, sort by age, and cleanup old logs
AND policy enforced (maxFiles AND maxAge both required)
Best-effort deletion continues on errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-retention-cleanup/05-02-SUMMARY.md`
</output>
