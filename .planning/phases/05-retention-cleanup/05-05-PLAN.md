---
phase: 05-retention-cleanup
plan: 05
type: tdd
wave: 5
depends_on: [05-04]
files_modified:
  - src/transports/file-transport.test.ts
  - README.md
autonomous: false
user_setup: []

must_haves:
  truths:
    - "Retention cleanup tests verify AND logic (both maxFiles AND maxAge required)"
    - "Tests cover edge cases (zero files, locked files, mixed .gz/uncompressed)"
    - "End-to-end integration test verifies full flow (rotation -> compression -> cleanup)"
    - "README.md documents retention feature with examples"
    - "Migration guide shows how to add retention to existing rotation"
  artifacts:
    - path: "src/transports/file-transport.test.ts"
      provides: "Comprehensive test suite for retention cleanup"
      contains: "retention cleanup tests including end-to-end integration"
    - path: "README.md"
      provides: "User-facing retention documentation"
      contains: "Log Retention section"
  key_links:
    - from: "README.md retention section"
      to: "FileTransport retention implementation"
      via: "Configuration examples and usage"
      pattern: "maxFiles.*maxAge"
    - from: "Migration guide"
      to: "Existing rotation configurations"
      via: "Before/after examples"
      pattern: "Add Retention.*Rotation"
    - from: "End-to-end integration test"
      to: "FileTransport.performRetentionCleanup"
      via: "setTimeout scheduling and cleanupOldLogs call"
      pattern: "setTimeout.*performRetentionCleanup|cleanupOldLogs"

---

<objective>
Add comprehensive tests for retention cleanup including end-to-end integration test, and document the feature in README.md with configuration examples and migration guide.

Purpose: Verify retention cleanup works correctly (AND logic, edge cases, full integration flow) and provide user-facing documentation for adoption.
Output: Test suite for retention cleanup with end-to-end integration test and README.md documentation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/05-retention-cleanup/05-CONTEXT.md
@.planning/phases/05-retention-cleanup/05-RESEARCH.md
@src/transports/file-transport.test.ts
@src/transports/file-transport.ts
@README.md
@.planning/phases/05-retention-cleanup/05-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>RED: Write failing tests for retention cleanup in FileTransport</name>
  <files>src/transports/file-transport.test.ts</files>
  <action>
    Add retention cleanup tests to src/transports/file-transport.test.ts:

    1. Validation tests:
       - Throws error if only maxFiles specified (without maxAge)
       - Throws error if only maxAge specified (without maxFiles)
       - Throws error if maxFiles < 1
       - Throws error if maxAge < 1
       - Accepts valid retention config (both maxFiles and maxAge)

    2. AND logic tests:
       - Does NOT delete files that exceed only maxFiles (but not maxAge)
       - Does NOT delete files that exceed only maxAge (but not maxFiles)
       - Deletes files that exceed BOTH maxFiles AND maxAge
       - Never deletes all files (protects current active file)

    3. Edge case tests:
       - Handles mixed .gz and uncompressed files
       - Handles locked files (best-effort, continues)
       - Returns correct deleted count and errors
       - Emits 'error' event on cleanup failures

    4. Integration tests:
       - Cleanup triggered after rotation
       - Cleanup timing (20ms delay after compression)
       - Cleanup doesn't block rotation (fire-and-forget)

    Use Vitest describe/it/expect pattern with dedicated test directories.
    Run with `npm test -- src/transports/file-transport.test.ts -t "retention"` to verify tests fail.
  </action>
  <verify>
    npm test -- src/transports/file-transport.test.ts -t "retention" 2>&1 | grep -E "(FAIL|passing|failing)"
  </verify>
  <done>
    Retention cleanup tests added to file-transport.test.ts
    Tests cover validation, AND logic, edge cases, and integration
    All tests fail (RED state) - implementation not yet verified
    Test file compiles and runs with Vitest
  </done>
</task>

<task type="auto">
  <name>GREEN: Verify tests pass with existing implementation</name>
  <files>src/transports/file-transport.test.ts</files>
  <action>
    Run retention cleanup tests to verify implementation from plan 05-04:

    npm test -- src/transports/file-transport.test.ts -t "retention"

    If tests fail, debug and fix the implementation or test expectations:
    - Check if retention config is correctly parsed
    - Verify cleanup is triggered after rotation
    - Ensure AND logic is enforced
    - Confirm edge cases are handled

    Continue iterating until all tests pass.
  </action>
  <verify>
    npm test -- src/transports/file-transport.test.ts -t "retention" 2>&1 | grep -E "passing|failing"
  </verify>
  <done>
    All retention cleanup tests pass (GREEN state)
    Implementation matches test expectations
    AND logic verified (both conditions required)
    Edge cases handled correctly
  </done>
</task>

<task type="auto">
  <name>REFACTOR: Clean up tests if needed</name>
  <files>src/transports/file-transport.test.ts</files>
  <action>
    Review retention cleanup tests for improvements:
    - Remove any test duplication
    - Improve test clarity if needed
    - Ensure consistent test structure
    - Verify all edge cases are covered

    Only refactor if clear improvements exist. If tests are clean, skip this task.
    Run tests after refactoring to ensure no regressions.
  </action>
  <verify>
    npm test -- src/transports/file-transport.test.ts -t "retention"
  </verify>
  <done>
    Tests are clean and maintainable
    All tests still pass
    No regressions introduced
  </done>
</task>

<task type="auto">
  <name>Task 4: Add end-to-end integration test for retention cleanup</name>
  <files>src/transports/file-transport.test.ts</files>
  <action>
    Add comprehensive end-to-end integration test to src/transports/file-transport.test.ts:

    Test scenario: "retention cleanup end-to-end flow"
    - Create FileTransport with retention config (maxFiles: 3, maxAge: 0 days)
    - Write enough logs to trigger rotation multiple times
    - Wait for rotation -> compression (10ms) -> cleanup (20ms total)
    - Verify old compressed files are deleted
    - Verify correct number of files remain (maxFiles threshold)
    - Verify current active file is never deleted

    This test verifies the complete flow:
    1. Rotation triggered by maxSize
    2. Compression scheduled (10ms delay)
    3. Cleanup scheduled (20ms delay = 10ms compression + 10ms buffer)
    4. performRetentionCleanup called via setTimeout
    5. cleanupOldLogs utility deletes old files
    6. Correct files deleted based on AND logic

    Use vi.useFakeTimers() for precise timing control if needed.
    Run test to verify it passes with existing implementation.
  </action>
  <verify>
    npm test -- src/transports/file-transport.test.ts -t "retention cleanup end-to-end" 2>&1 | grep -E "passing|failing"
  </verify>
  <done>
    End-to-end integration test added
    Test verifies full flow: rotation -> compression -> cleanup
    performRetentionCleanup integration confirmed via setTimeout
    cleanupOldLogs utility integration verified
    AND logic verified in real scenario
  </done>
</task>

<task type="auto">
  <name>Task 5: Add retention documentation to README.md</name>
  <files>README.md</files>
  <action>
    Add comprehensive "Log Retention" section to README.md (after "Log Compression" section):

    Structure:
    1. Overview section: What retention is and why it's useful
    2. Retention Policy section: Explain AND logic (both maxFiles AND maxAge required)
    3. Configuration Examples:
       - Default retention (20 files, 30 days)
       - Custom retention (different values)
       - Combined with rotation and compression
    4. How It Works section: Cleanup timing (after rotation), file selection, safety mechanisms
    5. Benefits section: Disk space management, automated cleanup, configurable thresholds
    6. Update RotationConfig Options table: Add maxFiles and maxAge fields

    Follow existing README documentation style (similar to compression section).
    Include TypeScript configuration examples.
    Explain that BOTH fields must be specified together.
  </action>
  <verify>
    grep -A 5 "## Log Retention" README.md | head -10
  </verify>
  <done>
    Log Retention section added to README.md
    Retention policy explained (AND logic)
    Configuration examples provided
    How It Works section explains cleanup behavior
    Benefits section highlights value
    RotationConfig table updated with maxFiles and maxAge
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete retention cleanup feature with comprehensive tests and documentation</what-built>
  <how-to-verify>
    1. Review README.md "Log Retention" section for clarity and completeness
    2. Check that configuration examples are practical and easy to understand
    3. Verify migration guidance is clear (how to add retention to existing rotation)
    4. Confirm AND logic is well-explained (both fields required)
    5. Run full test suite: npm test
    6. Verify all retention tests pass including end-to-end integration test
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to address</resume-signal>
</task>

<task type="auto">
  <name>Task 6: Add migration guide for retention cleanup</name>
  <files>README.md</files>
  <action>
    Add migration scenario to Migration Guide section in README.md:

    Scenario: "Add Retention to Existing Rotation"

    Before:
    ```typescript
    configure({
      file: './logs/app.log',
      rotation: {
        maxSize: '100MB',
        pattern: 'daily',
        compressionLevel: 6
      }
    });
    ```

    After:
    ```typescript
    configure({
      file: './logs/app.log',
      rotation: {
        maxSize: '100MB',
        pattern: 'daily',
        compressionLevel: 6,
        maxFiles: 20,    // Keep max 20 files
        maxAge: 30       // Delete files older than 30 days
      }
    });
    ```

    Explanation: "Retention cleanup runs automatically after each rotation. Files are deleted only if they exceed BOTH maxFiles AND maxAge thresholds."

    Add this after the compression migration scenario.
  </action>
  <verify>
    grep -A 20 "Add Retention to Existing Rotation" README.md
  </verify>
  <done>
    Migration scenario added for retention cleanup
    Before/after example shows how to add retention
    Explanation clarifies AND logic and automatic cleanup
    Positioned after compression migration scenario
  </done>
</task>

</tasks>

<verification>
- All retention cleanup tests pass including end-to-end integration test
- Tests cover validation, AND logic, edge cases, and integration
- End-to-end test verifies complete flow (rotation -> compression -> cleanup)
- README.md includes comprehensive retention documentation
- Configuration examples provided
- Migration guide shows how to add retention
- Documentation follows existing README style
- User approved documentation quality
</verification>

<success_criteria>
Retention cleanup feature fully tested and documented
Tests verify AND logic, edge cases, and end-to-end integration
README.md explains retention policy and usage
Migration guide provides adoption path
Phase 05 complete and ready for Phase 06
</success_criteria>

<output>
After completion, create `.planning/phases/05-retention-cleanup/05-05-SUMMARY.md`
</output>
