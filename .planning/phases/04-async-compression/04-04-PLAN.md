---
phase: 04-async-compression
plan: 04
type: tdd
wave: 3
depends_on: [04-03]
files_modified: [test/file-transport.test.ts, test/compression.test.ts]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Comprehensive test coverage for compression workflow"
    - "Tests verify compression level configuration"
    - "Tests verify .gz file creation after rotation"
    - "Tests verify original file deletion after success"
    - "Tests verify failed file handling (moved to failed/)"
    - "Tests verify fire-and-forget pattern (no blocking)"
    - "Tests verify 10ms delay before compression starts"
    - "All existing tests still pass"
  artifacts:
    - path: "test/compression.test.ts"
      provides: "Compression utility tests"
      exports: ["compressRotatedFile tests"]
      min_lines: 100
    - path: "test/file-transport.test.ts"
      provides: "Compression integration tests"
      contains: "compression tests"
      min_lines: 50  # New compression integration tests
  key_links:
    - from: "test/compression.test.ts"
      to: "src/utils/compression.ts"
      via: "import compressRotatedFile"
      pattern: "import.*compressRotatedFile"
    - from: "test/file-transport.test.ts"
      to: "src/transports/file-transport.ts"
      via: "import FileTransport"
      pattern: "import.*FileTransport"
---

<objective>
Add comprehensive test coverage for async compression using TDD methodology

Purpose: Verify compression workflow, error handling, and fire-and-forget behavior
Output: Complete test suite for compression with RED-GREEN-REFACTOR cycle
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/04-async-compression/04-CONTEXT.md
@.planning/phases/04-async-compression/04-RESEARCH.md
@src/utils/compression.ts
@src/transports/file-transport.ts
@test/file-transport.test.ts
</context>

<feature>
  <name>Async gzip compression of rotated log files</name>
  <files>src/utils/compression.ts, src/transports/file-transport.ts</files>
  <behavior>
    Test cases for compression utility and integration:

    **compressRotatedFile utility tests (test/compression.test.ts):**
    1. Successful compression creates .gz file
    2. Original file deleted after successful compression
    3. Compression level 1 creates larger file (fastest)
    4. Compression level 9 creates smaller file (slowest)
    5. Failed compression moves file to failed/ directory
    6. Failed compression logs error to console
    7. Cross-device rename error leaves file in place with warning
    8. Partial .gz files cleaned up on error

    **FileTransport integration tests (test/file-transport.test.ts):**
    9. Compression scheduled after rotation completes
    10. Compression only runs when compressionLevel is set
    11. Compression validates level is 1-9 (throws if invalid)
    12. 10ms delay before compression starts
    13. Fire-and-forget: rotation completes without waiting for compression
    14. Multiple rotations trigger multiple compressions
    15. Compression errors don't crash the application
  </behavior>
  <implementation>
    **RED Phase:** Write failing tests for all 15 behaviors

    **GREEN Phase:** Implement compression to make tests pass
    - All tests from 04-01, 04-02, 04-03 should already pass
    - Fix any failing tests with minimal implementation changes

    **REFACTOR Phase:** Clean up test code and implementation
    - Extract test helpers if duplication exists
    - Improve test readability
    - Ensure all tests still pass after refactoring

    Use Vitest fake timers if needed for timing tests (10ms delay)
    Use dedicated test directories to avoid interference
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>Task 1: Create compression utility tests (RED phase)</name>
  <files>test/compression.test.ts</files>
  <action>
    Create test/compression.test.ts with comprehensive tests for compressRotatedFile:

    **Test setup:**
    - Import compressRotatedFile from utils/compression
    - Import fs from node:fs, path from node:path
    - Use dedicated test directory: ./test-logs-compression
    - Clean up test files after each test

    **Test cases (RED - all should fail initially):**

    1. `should create .gz file after compression`
       - Create test file with known content
       - Call compressRotatedFile with level 6
       - Await completion
       - Verify .gz file exists
       - Verify original file deleted

    2. `should use compression level 1 (fastest)`
       - Create test file
       - Compress with level 1
       - Verify .gz file exists and is larger than level 6

    3. `should use compression level 9 (best compression)`
       - Create test file
       - Compress with level 9
       - Verify .gz file exists and is smaller than level 1

    4. `should move failed file to failed/ directory on error`
       - Mock createReadStream to throw error
       - Call compressRotatedFile
       - Verify file moved to failed/ subdirectory
       - Verify .gz file does not exist

    5. `should log error to console on compression failure`
       - Mock console.error
       - Mock createReadStream to throw error
       - Call compressRotatedFile
       - Verify console.error called with error message

    6. `should handle cross-device rename error (EXDEV)`
       - Mock fs.promises.rename to throw EXDEV error
       - Call compressRotatedFile
       - Verify file left in place (not moved)
       - Verify warning logged to console

    7. `should delete original file only after successful compression`
       - Create test file
       - Spy on fs.promises.unlink
       - Compress file
       - Verify unlink called after compression completes

    8. `should create failed/ directory if it does not exist`
       - Ensure failed/ directory doesn't exist
       - Mock createReadStream to throw error
       - Call compressRotatedFile
       - Verify failed/ directory created

    Run tests and verify they all FAIL (RED phase)
  </action>
  <verify>
  Run: `npm test -- test/compression.test.ts`
  Expected: All tests FAIL with "Implementation missing" errors
  </verify>
  <done>
  All compression utility tests written and failing (RED phase complete)
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement compression to pass tests (GREEN phase)</name>
  <files>src/utils/compression.ts</files>
  <action>
    Implement compressRotatedFile in src/utils/compression.ts to make tests pass:

    This is already implemented in plan 04-02. Verify all tests pass:
    - Run `npm test -- test/compression.test.ts`
    - All tests should PASS
    - If any tests fail, fix implementation (not tests)
    - Commit: `feat(04-02): implement compressRotatedFile utility`

    **Minimal fixes only** - don't add features beyond what tests require
  </action>
  <verify>
  Run: `npm test -- test/compression.test.ts`
  Expected: All tests PASS
  </verify>
  <done>
  All compression utility tests passing (GREEN phase complete)
  </done>
</task>

<task type="auto">
  <name>Task 3: Add FileTransport integration tests (RED phase)</name>
  <files>test/file-transport.test.ts</files>
  <action>
    Add compression integration tests to test/file-transport.test.ts:

    **Test setup:**
    - Use dedicated test directory: ./test-logs-compression-integration
    - Import FileTransport, configure
    - Clean up test files after each test

    **Test cases (RED - all should fail initially):**

    9. `should schedule compression after rotation when compressionLevel set`
       - Create FileTransport with maxSize and compressionLevel 6
       - Write logs to trigger rotation
       - Wait for rotation to complete
       - Verify .gz file created after delay

    10. `should not compress when compressionLevel not set`
        - Create FileTransport with maxSize but no compressionLevel
        - Write logs to trigger rotation
        - Verify .gz file not created

    11. `should throw error for invalid compression level`
        - Try to create FileTransport with compressionLevel 0
        - Verify error thrown
        - Try to create FileTransport with compressionLevel 10
        - Verify error thrown

    12. `should wait 10ms before starting compression`
        - Create FileTransport with compressionLevel 6
        - Mock setTimeout to track calls
        - Trigger rotation
        - Verify setTimeout called with 10ms delay

    13. `should complete rotation without waiting for compression (fire-and-forget)`
        - Create FileTransport with compressionLevel 6
        - Track rotation completion time
        - Write logs to trigger rotation
        - Verify rotation completes quickly (doesn't wait for compression)

    14. `should handle multiple rotations with multiple compressions`
        - Create FileTransport with small maxSize and compressionLevel 6
        - Write many logs to trigger multiple rotations
        - Verify multiple .gz files created

    15. `should not crash on compression errors`
        - Mock compressRotatedFile to reject
        - Create FileTransport with compressionLevel 6
        - Trigger rotation
        - Verify rotation completes despite compression error

    Run tests and verify they all FAIL (RED phase)
  </action>
  <verify>
  Run: `npm test -- test/file-transport.test.ts -t "compression"`
  Expected: All new compression tests FAIL (existing tests still pass)
  </verify>
  <done>
  All FileTransport compression integration tests written and failing (RED phase complete)
  </done>
</task>

<task type="auto">
  <name>Task 4: Implement compression integration to pass tests (GREEN phase)</name>
  <files>src/transports/file-transport.ts</files>
  <action>
    Implement compression integration in src/transports/file-transport.ts to make tests pass:

    This is already implemented in plan 04-03. Verify all tests pass:
    - Run `npm test -- test/file-transport.test.ts -t "compression"`
    - All compression tests should PASS
    - Run `npm test` to verify all existing tests still pass
    - If any tests fail, fix implementation (not tests)
    - Commit: `feat(04-03): integrate compression scheduling into FileTransport`

    **Minimal fixes only** - don't add features beyond what tests require
  </action>
  <verify>
  Run: `npm test`
  Expected: All tests PASS (existing + new compression tests)
  </verify>
  <done>
  All compression integration tests passing (GREEN phase complete)
  </done>
</task>

<task type="auto">
  <name>Task 5: Refactor tests and implementation (REFACTOR phase)</name>
  <files>test/compression.test.ts, test/file-transport.test.ts</files>
  <action>
    Refactor test code and implementation for clarity and maintainability:

    **Test refactoring:**
    - Extract common test setup helpers (create test file, verify compression)
    - Reduce duplication in test cases
    - Improve test descriptions for clarity
    - Ensure test isolation (cleanup between tests)

    **Implementation refactoring (if needed):**
    - Look for code duplication in compression.ts and file-transport.ts
    - Extract helper functions if beneficial
    - Improve variable naming for clarity
    - Add JSDoc comments if missing

    After refactoring:
    - Run `npm test` to verify all tests still pass
    - Run `npm run build` to verify TypeScript compilation
    - Commit: `refactor(04-04): clean up compression tests and implementation`
  </action>
  <verify>
  Run: `npm test`
  Expected: All tests PASS (no regressions from refactoring)
  </verify>
  <done>
  Tests and implementation refactored for clarity and maintainability
  </done>
</task>

</tasks>

<verification>
- All 15 compression tests pass
- All existing tests still pass (no regressions)
- Test coverage comprehensive (utility + integration tests)
- Tests follow TDD cycle (RED -> GREEN -> REFACTOR)
</verification>

<success_criteria>
Complete compression test suite with:
- 8 utility tests for compressRotatedFile function
- 7 integration tests for FileTransport compression scheduling
- All tests passing with comprehensive coverage
- TDD cycle completed (RED -> GREEN -> REFACTOR)
- No regressions in existing test suite
- Clean, maintainable test code
</success_criteria>

<output>
After completion, create `.planning/phases/04-async-compression/04-04-SUMMARY.md`
</output>
