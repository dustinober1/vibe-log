---
phase: 07-public-api-integration-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config.ts
  - test/config.test.ts
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "User can configure compressionLevel via configure() shorthand API"
    - "User can configure maxFiles and maxAge via configure() shorthand API"
    - "All rotation options (maxSize, pattern, compressionLevel, maxFiles, maxAge) are passed to FileTransport"
    - "Public API configuration E2E flow works end-to-end"
  artifacts:
    - path: "src/config.ts"
      provides: "configure() function with complete rotation options passthrough"
      contains: "compressionLevel, maxFiles, maxAge field assignment"
    - path: "test/config.test.ts"
      provides: "Test coverage for compression and retention passthrough"
      exports: ["compressionLevel passthrough test", "retention passthrough test"]
  key_links:
    - from: "src/config.ts"
      to: "src/transports/file-transport.ts"
      via: "FileTransport constructor with FileTransportOptions"
      pattern: "new FileTransport\\(file, fileTransportOptions\\)"
---

<objective>
Fix critical public API integration gap where configure() shorthand API does not pass compressionLevel, maxFiles, and maxAge rotation options to FileTransport.

Purpose: Enable users to access Phase 04 (compression) and Phase 05 (retention) features via the public configure() API, eliminating need to use FileTransport constructor directly.

Output: Working configure({ file, rotation: { compressionLevel, maxFiles, maxAge } }) API with test coverage
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/v1.1-MILESTONE-AUDIT.md
@.planning/phases/07-public-api-integration-fix/07-PLAN.md
@src/config.ts
@src/transports/file-transport.ts
@test/config.test.ts
</context>

<tasks>

<task type="auto">
  <id>01</id>
  <description>Update fileTransportOptions type definition</description>
  <files>src/config.ts</files>
  <action>
    Update line 70 in src/config.ts to extend the type definition for fileTransportOptions.

    Current code:
    ```typescript
    const fileTransportOptions: { maxSize?: string | number; pattern?: 'daily' } = {};
    ```

    Replace with:
    ```typescript
    const fileTransportOptions: {
        maxSize?: string | number;
        pattern?: 'daily';
        compressionLevel?: number;
        maxFiles?: number;
        maxAge?: number;
    } = {};
    ```

    This change allows the configure() function to accept and pass through all FileTransport rotation options.
  </action>
  <verify>grep -A 5 "fileTransportOptions:" src/config.ts | grep -E "(compressionLevel|maxFiles|maxAge)"</verify>
  <done>Type definition includes compressionLevel, maxFiles, and maxAge fields</done>
</task>

<task type="auto">
  <id>02</id>
  <description>Add field passthrough logic for rotation options</description>
  <files>src/config.ts</files>
  <action>
    After the existing pattern check (line 76-78 in src/config.ts), add passthrough logic for compressionLevel, maxFiles, and maxAge.

    Insert this code after line 78 (after the pattern check):
    ```typescript
        // Pass compression level to FileTransport
        if (rotation?.compressionLevel !== undefined) {
            fileTransportOptions.compressionLevel = rotation.compressionLevel;
        }

        // Pass retention configuration to FileTransport
        if (rotation?.maxFiles !== undefined) {
            fileTransportOptions.maxFiles = rotation.maxFiles;
        }

        if (rotation?.maxAge !== undefined) {
            fileTransportOptions.maxAge = rotation.maxAge;
        }
    ```

    Important: Use !== undefined check (not truthy check) to allow 0 as a valid value for maxFiles/maxAge edge cases.
  </action>
  <verify>grep -n "compressionLevel\|maxFiles\|maxAge" src/config.ts | grep -v "^//"</verify>
  <done>All three rotation options are passed to FileTransport constructor</done>
</task>

<task type="auto">
  <id>03</id>
  <description>Add test for compressionLevel passthrough</description>
  <files>test/config.test.ts</files>
  <action>
    Add a new test in the "rotation configuration" describe block (after line 228) to verify compressionLevel is passed through to FileTransport.

    Insert this test:
    ```typescript
        it('should pass compressionLevel to FileTransport', () => {
            configure({
                file: path.join(testLogsDir, 'compression.log'),
                rotation: { compressionLevel: 9 }
            });

            const config = getConfig();
            expect(config.rotation?.compressionLevel).toBe(9);

            // Verify the transport was created and can log
            expect(() => log.info('test', 'Test message with compression')).not.toThrow();
        });
    ```

    Place this test after the existing "should work without any rotation config" test (around line 228).
  </action>
  <verify>grep -A 10 "should pass compressionLevel to FileTransport" test/config.test.ts</verify>
  <done>Test verifies compressionLevel is stored in config and FileTransport is created successfully</done>
</task>

<task type="auto">
  <id>04</id>
  <description>Add test for retention passthrough (maxFiles/maxAge)</description>
  <files>test/config.test.ts</files>
  <action>
    Add a new test in the "rotation configuration" describe block to verify maxFiles and maxAge are passed through to FileTransport.

    Insert this test after the compressionLevel test from Task 03:
    ```typescript
        it('should pass maxFiles and maxAge to FileTransport', () => {
            configure({
                file: path.join(testLogsDir, 'retention.log'),
                rotation: { maxFiles: 10, maxAge: 7 }
            });

            const config = getConfig();
            expect(config.rotation?.maxFiles).toBe(10);
            expect(config.rotation?.maxAge).toBe(7);

            // Verify the transport was created and can log
            expect(() => log.info('test', 'Test message with retention')).not.toThrow();
        });
    ```

    This test verifies that both retention options are passed through correctly and FileTransport is created.
  </action>
  <verify>grep -A 10 "should pass maxFiles and maxAge to FileTransport" test/config.test.ts</verify>
  <done>Test verifies maxFiles and maxAge are stored in config and FileTransport is created successfully</done>
</task>

</tasks>

<verification>
After completing all tasks, verify the gap is closed:

```bash
# Run all tests - should pass (218/218 with 2 new tests)
npm test

# Run specific config tests
npm test -- test/config.test.ts

# Verify integration score improved
grep "integration: 9/9" .planning/v1.1-MILESTONE-AUDIT.md || echo "Score still 8/9 - audit file needs manual update"

# Verify type definition includes all fields
grep -A 5 "fileTransportOptions:" src/config.ts | grep -E "(compressionLevel|maxFiles|maxAge)"

# Verify passthrough logic exists
grep -n "compressionLevel\|maxFiles\|maxAge" src/config.ts | grep "rotation\?"
```

Expected results:
- All 218 tests pass (216 existing + 2 new)
- Type definition includes compressionLevel, maxFiles, maxAge
- Passthrough logic present with !== undefined checks
- E2E flow "Public API configuration" works end-to-end
</verification>

<success_criteria>
Gap is closed when:
- [ ] src/config.ts type definition includes compressionLevel, maxFiles, maxAge fields
- [ ] src/config.ts passes all three fields to FileTransport constructor
- [ ] New test for compressionLevel passthrough passes
- [ ] New test for retention passthrough passes
- [ ] All existing tests still pass (216/216)
- [ ] Total test count is 218/218
- [ ] Public API configuration E2E flow works
</success_criteria>

<output>
After completion, create `.planning/phases/07-public-api-integration-fix/07-01-SUMMARY.md` with:
- Changes made to src/config.ts (type definition + passthrough logic)
- Tests added to test/config.test.ts
- Test results (218/218 passing)
- Integration score improvement (8/9 -> 9/9)
- E2E flow verification
</output>
