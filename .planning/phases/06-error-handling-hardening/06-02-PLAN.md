---
phase: 06-error-handling-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - test/integration.test.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "All integration tests pass when run in parallel"
    - "Each test suite uses unique test directory (UUID-based)"
    - "beforeEach creates unique directory for each test"
    - "afterEach cleans up only that test's directory"
    - "No shared 'test-logs' directory between test files"
  artifacts:
    - path: "test/integration.test.ts"
      provides: "Integration tests with unique directories per test run"
      contains: "randomUUID() for unique test directories"
  key_links:
    - from: "test/integration.test.ts"
      to: "crypto.randomUUID()"
      via: "unique directory generation"
      pattern: "randomUUID\\(\\)"
    - from: "beforeEach"
      to: "unique test directory"
      via: "test isolation"
      pattern: "testDir.*randomUUID"
---

<objective>
Fix integration test isolation issues by implementing unique test directories using UUID to prevent interference when tests run in parallel.

Purpose: Resolve ENOENT errors caused by shared 'test-logs' directory cleanup in parallel test runs, ensuring all 216 tests pass reliably.

Output: Updated integration test file with UUID-based unique directories, enabling reliable parallel test execution.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-error-handling-hardening/06-CONTEXT.md
@.planning/phases/06-error-handling-hardening/06-RESEARCH.md
@.planning/STATE.md

@test/integration.test.ts
</context>

<tasks>

<task type="auto">
  <name>Add UUID import and update test directory to use UUID</name>
  <files>test/integration.test.ts</files>
  <action>
    Import randomUUID from crypto and update testDir to use UUID for unique directories:

    1. Add import at top with other imports:
       import { randomUUID } from 'node:crypto';

    2. Update the testDir declaration (line 9):
       const testDir = path.join(process.cwd(), `test-logs-${randomUUID()}`);

    This ensures each test run gets a unique directory, preventing interference when Vitest runs test files in parallel.
  </action>
  <verify>
    grep -n "test-logs-.*randomUUID" test/integration.test.ts
  </verify>
  <done>
    Integration test uses unique UUID-based directory per test run
  </done>
</task>

<task type="auto">
  <name>Verify tests pass with unique directories</name>
  <files>test/integration.test.ts</files>
  <action>
    Run the full test suite to verify all tests pass with the unique directory change:

    1. Run: npm test
    2. Verify output shows "216 passed" (all tests pass)
    3. Verify no ENOENT errors for test-logs directory

    If tests still fail, the issue may be in other test files using shared 'test-logs' directory.
  </action>
  <verify>
    npm test 2>&1 | tail -20
  </verify>
  <done>
    All 216 tests pass when run in parallel with unique directories
  </done>
</task>

</tasks>

<verification>
- randomUUID imported from node:crypto
- testDir uses path.join with `test-logs-${randomUUID()}`
- beforeEach creates unique directory
- afterEach cleans up only that test's directory
- All 216 tests pass (no ENOENT errors)
- Tests pass when run in parallel (default Vitest behavior)
</verification>

<success_criteria>
- Integration tests use unique directories per test run
- No shared 'test-logs' directory conflicts
- All tests pass in parallel execution
- Test isolation maintained without sequential execution
</success_criteria>

<output>
After completion, create `.planning/phases/06-error-handling-hardening/06-02-SUMMARY.md`
</output>
