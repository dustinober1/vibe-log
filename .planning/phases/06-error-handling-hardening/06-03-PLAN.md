---
phase: 06-error-handling-hardening
plan: 03
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - src/transports/file-transport.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Directory deleted during runtime triggers recreation attempt"
    - "ENOSPC (disk full) stops accepting writes with disk-full event"
    - "EACCES (permission denied) fails permanently with permission-denied event"
    - "Write operations check for disk-full and permission-denied flags"
    - "Rotation attempts directory recreation if ENOENT occurs"
  artifacts:
    - path: "src/transports/file-transport.ts"
      provides: "Edge case handling for directory deletion, disk full, and permission errors"
      contains: "handleDirectoryError, isDiskFull, isPermissionDenied methods"
  key_links:
    - from: "FileTransport.log"
      to: "error state flags"
      via: "write gating checks"
      pattern: "isDiskFull\\(\\)|isPermissionDenied\\(\\)"
    - from: "FileTransport.performRotation"
      to: "directory recreation"
      via: "ENOENT error handling"
      pattern: "ENOENT.*recreate"
---

<objective>
Implement edge case hardening for production scenarios: directory deletion during runtime, disk full errors, and permission denied errors.

Purpose: Handle common production edge cases gracefully by implementing directory recreation attempts, disk-full write gating, and permission-denied failure handling.

Output: Enhanced FileTransport with production-ready edge case handling and clear error states.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-error-handling-hardening/06-CONTEXT.md
@.planning/phases/06-error-handling-hardening/06-RESEARCH.md
@.planning/STATE.md
@.planning/phases/06-error-handling-hardening/06-01-SUMMARY.md

@src/transports/file-transport.ts
</context>

<tasks>

<task type="auto">
  <name>Add disk-full and permission-denied flag methods</name>
  <files>src/transports/file-transport.ts</files>
  <action>
    Add two private methods to check error state flags after the closed property:

    ```typescript
    /**
     * Check if disk is full (ENOSPC error occurred)
     */
    private isDiskFull(): boolean {
        return this.rotating && this.stream.listenerCount('error') > 0;
    }

    /**
     * Check if permission was denied (EACCES error occurred)
     */
    private isPermissionDenied(): boolean {
        return this.closed;
    }
    ```

    Place these after the `closed` property declaration (around line 96).
  </action>
  <verify>
    grep -n "isDiskFull\|isPermissionDenied" src/transports/file-transport.ts
  </verify>
  <done>
    Error state check methods added for disk-full and permission-denied conditions
  </done>
</task>

<task type="auto">
  <name>Update log() to check error state flags</name>
  <files>src/transports/file-transport.ts</files>
  <action>
    Update the log() method to check error state flags before attempting writes.

    Add these checks at the start of the log() method (after the method signature, before existing logic):

    ```typescript
    // Check error state flags before writing
    if (this.isDiskFull() || this.isPermissionDenied()) {
        return;  // Skip writes on error state
    }
    ```

    Place this immediately after the `log(formatted: string, _entry: LogEntry, _config: LoggerConfig): void {` line.
  </action>
  <verify>
    grep -A 3 "log(formatted: string" src/transports/file-transport.ts | grep "isDiskFull\\|isPermissionDenied"
  </verify>
  <done>
    log() method checks error state flags and skips writes when disk full or permission denied
  </done>
</task>

<task type="auto">
  <name>Add directory recreation method</name>
  <files>src/transports/file-transport.ts</files>
  <action>
    Add a private method to attempt directory recreation when ENOENT occurs during rotation:

    ```typescript
    /**
     * Attempt to recreate log directory if it was deleted
     *
     * @returns true if recreation succeeded, false otherwise
     */
    private recreateDirectory(): boolean {
        const dir = path.dirname(this.filePath);
        try {
            fs.mkdirSync(dir, { recursive: true });
            console.error(`[FileTransport] Recreated directory: ${dir}`);
            return true;
        } catch (error) {
            const err = error as NodeJS.ErrnoException;
            console.error(`[FileTransport] Failed to recreate directory: ${err.message}`);
            return false;
        }
    }
    ```

    Place this method after the createWriteStream method.
  </action>
  <verify>
    grep -n "recreateDirectory" src/transports/file-transport.ts
  </verify>
  <done>
    Directory recreation method added to handle ENOENT during runtime
  </done>
</task>

<task type="auto">
  <name>Update performRotation to handle directory deletion</name>
  <files>src/transports/file-transport.ts</files>
  <action>
    Update performRotation to attempt directory recreation when ENOENT occurs.

    In the performRotation method, update the stream.end callback to handle ENOENT:

    Find the fs.rename error handling section (around line 370) and update it:

    ```typescript
    fs.rename(this.filePath, rotatedPath, (renameErr: NodeJS.ErrnoException | null) => {
        if (renameErr) {
            // Handle directory deletion during runtime
            if (renameErr.code === 'ENOENT') {
                // Attempt directory recreation
                if (this.recreateDirectory()) {
                    // Retry the rename after recreation
                    fs.rename(this.filePath, rotatedPath, (retryErr: NodeJS.ErrnoException | null) => {
                        if (retryErr) {
                            this.stream = this.createWriteStream(this.filePath);
                            reject(retryErr);
                            return;
                        }
                        // Success after recreation - continue with rotation
                        this.stream = this.createWriteStream(this.filePath);
                        this.currentFileSize = 0;
                        // ... rest of rotation logic (compression, cleanup)
                        resolve();
                    });
                    return;
                }
            }
            // Other errors or recreation failed â€” try to recover
            this.stream = this.createWriteStream(this.filePath);
            reject(renameErr);
            return;
        }

        // ... existing success path continues unchanged
    ```
  </action>
  <verify>
    grep -B 2 -A 10 "ENOENT.*recreateDirectory" src/transports/file-transport.ts
  </verify>
  <done>
    Rotation attempts directory recreation when ENOENT occurs during file rename
  </done>
</task>

</tasks>

<verification>
- isDiskFull() method checks rotating flag and error listeners
- isPermissionDenied() method checks closed flag
- log() checks both flags before attempting writes
- recreateDirectory() attempts to create directory with recursive option
- performRotation handles ENOENT with directory recreation attempt
- Directory recreation failure emits error and falls back to recovery
- Error states prevent writes but don't crash application
</verification>

<success_criteria>
- Disk full errors stop writes with clear state flag
- Permission denied errors permanently stop transport
- Directory deletion triggers recreation attempt during rotation
- All edge cases handled without crashing application
- Console.error logging aids debugging
</success_criteria>

<output>
After completion, create `.planning/phases/06-error-handling-hardening/06-03-SUMMARY.md`
</output>
