---
phase: 06-error-handling-hardening
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - docs/TROUBLESHOOTING.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "TROUBLESHOOTING.md exists in docs directory"
    - "ENOSPC (disk full) error documented with symptoms, diagnostics, solutions"
    - "EACCES (permission denied) error documented with solutions"
    - "Directory deletion issues documented with diagnostic steps"
    - "Multi-process limitation clearly documented with workarounds"
    - "Log file not growing documented with verification steps"
    - "Rotation not working documented with solutions"
    - "Compression failures documented with troubleshooting steps"
    - "Getting help section included with GitHub link"
  artifacts:
    - path: "docs/TROUBLESHOOTING.md"
      provides: "Production troubleshooting guide for common errors"
      contains: "Common Errors, Symptoms, Solutions, Diagnostic Steps"
  key_links:
    - from: "README.md"
      to: "docs/TROUBLESHOOTING.md"
      via: "troubleshooting link"
      pattern: "TROUBLESHOOTING\\.md"
---

<objective>
Create comprehensive production troubleshooting documentation covering common errors, diagnostic steps, and solutions for production issues.

Purpose: Provide operators with clear guidance for diagnosing and resolving production logging issues including disk full, permission errors, file system issues, and multi-process limitations.

Output: docs/TROUBLESHOOTING.md with error scenarios, symptoms, diagnostic steps, and solutions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-error-handling-hardening/06-CONTEXT.md
@.planning/phases/06-error-handling-hardening/06-RESEARCH.md
@.planning/STATE.md

@README.md
</context>

<tasks>

<task type="auto">
  <name>Create TROUBLESHOOTING.md file with header and table of contents</name>
  <files>docs/TROUBLESHOOTING.md</files>
  <action>
    Create the docs directory if it doesn't exist, then create TROUBLESHOOTING.md with:

    ```markdown
    # Troubleshooting Guide

    This guide helps you diagnose and resolve common production issues with log-vibe.

    ## Table of Contents

    - [Disk Full Errors](#disk-full-errors-enospc)
    - [Permission Errors](#permission-errors-eacces)
    - [Directory Issues](#directory-issues)
    - [Multi-Process Limitations](#multi-process-limitations)
    - [Log File Not Growing](#log-file-not-growing)
    - [Rotation Not Working](#rotation-not-working)
    - [Compression Failures](#compression-failures)
    - [Getting Help](#getting-help)
    ```

    Create the docs directory first: mkdir -p docs
  </action>
  <verify>
    test -d docs && test -f docs/TROUBLESHOOTING.md && grep -q "Table of Contents" docs/TROUBLESHOOTING.md
  </verify>
  <done>
    TROUBLESHOOTING.md file created with table of contents
  </done>
</task>

<task type="auto">
  <name>Add Disk Full Errors (ENOSPC) section</name>
  <files>docs/TROUBLESHOOTING.md</files>
  <action>
    Append the Disk Full Errors section after the table of contents:

    ```markdown
    ## Disk Full Errors (ENOSPC)

    ### Symptoms

    - Logs stop appearing in file
    - Application continues running but no new logs
    - Console message: `[FileTransport] Write error: ENOSPC - No space left on device`
    - `disk-full` event emitted if you're listening

    ### Causes

    - Disk partition is full
    - Log files filled available disk space
    - Retention policy not configured or too permissive

    ### Diagnostic Steps

    1. Check disk space:
       ```bash
       df -h /path/to/logs
       ```

    2. Check log directory size:
       ```bash
       du -sh /path/to/logs
       ```

    3. List oldest/largest log files:
       ```bash
       ls -lhS /path/to/logs  # Largest files
       ls -lht /path/to/logs  # Most recent
       ```

    ### Solutions

    **Immediate:**
    1. Free disk space by deleting old log files manually:
       ```bash
       cd /path/to/logs
       rm app-2025-*.log.*.gz  # Delete old compressed logs
       ```

    2. Move log directory to larger partition:
       ```bash
       mv /path/to/logs /larger/partition/logs
       ln -s /larger/partition/logs /path/to/logs
       ```

    **Long-term:**
    1. Enable retention cleanup:
       ```typescript
       configure({
         file: './logs/app.log',
         rotation: {
           maxSize: '100MB',
           maxFiles: 20,    // Keep max 20 files
           maxAge: 30       // Delete files older than 30 days
         }
       });
       ```

    2. Enable compression to reduce disk usage:
       ```typescript
       configure({
         file: './logs/app.log',
         rotation: {
           maxSize: '100MB',
           compressionLevel: 6  // 5-10x space savings
         }
       });
       ```

    3. Monitor disk space and set up alerts:
       ```bash
       # Add to crontab for hourly checks
       0 * * * * df -h /path/to/logs | awk '{print $5}' | grep -E '9[0-9]%' && mail -s "Disk full alert" admin@example.com
       ```
    ```
  </action>
  <verify>
    grep -q "Disk Full Errors" docs/TROUBLESHOOTING.md && grep -q "ENOSPC" docs/TROUBLESHOOTING.md
  </verify>
  <done>
    ENOSPC (disk full) error documented with symptoms, causes, diagnostics, and solutions
  </done>
</task>

<task type="auto">
  <name>Add Permission Errors (EACCES) section</name>
  <files>docs/TROUBLESHOOTING.md</files>
  <action>
    Append the Permission Errors section after Disk Full Errors:

    ```markdown
    ## Permission Errors (EACCES)

    ### Symptoms

    - Logs fail to write immediately on startup
    - Application may crash or fail to start
    - Console message: `[FileTransport] Write error: EACCES - Permission denied`
    - `permission-denied` event emitted if you're listening

    ### Causes

    - Log directory owned by different user
    - Insufficient permissions on log directory or file
    - Running as different user than created log files

    ### Diagnostic Steps

    1. Check directory ownership:
       ```bash
       ls -ld /path/to/logs
       ```

    2. Check file ownership:
       ```bash
       ls -l /path/to/logs
       ```

    3. Check current user:
       ```bash
       whoami
       ```

    ### Solutions

    **Fix ownership:**
    ```bash
    # Change ownership to current user
    sudo chown -R $USER:$USER /path/to/logs
    ```

    **Fix permissions:**
    ```bash
    # Grant read/write/execute to owner
    chmod 700 /path/to/logs

    # Grant read/write to owner and group
    chmod 770 /path/to/logs

    # Grant read/write to all users (less secure)
    chmod 777 /path/to/logs
    ```

    **Run with correct user:**
    ```bash
    # Start application with log directory owner
    sudo -u loguser node app.js
    ```
    ```
  </action>
  <verify>
    grep -q "Permission Errors" docs/TROUBLESHOOTING.md && grep -q "EACCES" docs/TROUBLESHOOTING.md
  </verify>
  <done>
    EACCES (permission denied) error documented with diagnostic steps and solutions
  </done>
</task>

<task type="auto">
  <name>Add Directory Issues section</name>
  <files>docs/TROUBLESHOOTING.md</files>
  <action>
    Append the Directory Issues section after Permission Errors:

    ```markdown
    ## Directory Issues

    ### Symptoms

    - `ENOENT: no such file or directory` errors
    - Directory deleted during runtime
    - External process cleaning up log directory

    ### Diagnostic Steps

    1. Check if directory exists:
       ```bash
       ls -la /path/to/logs
       ```

    2. Monitor directory changes:
       ```bash
       watch -n 5 'ls -la /path/to/logs'
       ```

    3. Check for cleanup processes:
       ```bash
       ps aux | grep -E 'logrotate|tmpwatch|cleanup'
       ```

    ### Solutions

    **Manual recreation:**
    ```bash
    mkdir -p /path/to/logs
    chmod 755 /path/to/logs
    ```

    **Prevent external cleanup:**
    - Exclude log directory from tmpwatch/tmpreaper
    - Configure logrotate to use `copytruncate` instead of deleting
    - Set appropriate retention policy instead of external cleanup

    **Handle in application:**
    log-vibe will attempt to recreate the directory if it's deleted during rotation. Monitor for `error` events.
    ```
  </action>
  <verify>
    grep -q "Directory Issues" docs/TROUBLESHOOTING.md && grep -q "ENOENT" docs/TROUBLESHOOTING.md
  </verify>
  <done>
    Directory deletion issues documented with diagnostic steps and solutions
  </done>
</task>

<task type="auto">
  <name>Add Multi-Process Limitations section</name>
  <files>docs/TROUBLESHOOTING.md</files>
  <action>
    Append the Multi-Process Limitations section after Directory Issues:

    ```markdown
    ## Multi-Process Limitations

    ### Symptoms

    - Log entries missing or corrupted
    - Rotation fails intermittently
    - Sequence numbers collide in rotated files

    ### Cause

    log-vibe does NOT support multi-process writing to the same log file. Multiple processes writing to the same file can cause:
    - Data corruption
    - Lost log entries
    - Rotation failures
    - Race conditions

    ### Solutions

    **Use separate log files per process:**
    ```typescript
    // Process 1
    configure({ file: './logs/app-1.log' });

    // Process 2
    configure({ file: './logs/app-2.log' });
    ```

    **Use process ID in filename:**
    ```typescript
    configure({
      file: `./logs/app-${process.pid}.log`
    });
    ```

    **Use a logging server (recommended for production):**
    - Run a dedicated logging process
    - Other processes send logs via IPC/network
    - Centralized logger writes to disk safely

    **Alternative: Use syslog:**
    ```typescript
    import { configure, SyslogTransport } from 'log-vibe';

    configure({
      transports: [new SyslogTransport()]
    });
    ```
    ```
  </action>
  <verify>
    grep -q "Multi-Process Limitations" docs/TROUBLESHOOTING.md && grep -q "does NOT support" docs/TROUBLESHOOTING.md
  </verify>
  <done>
    Multi-process limitation prominently documented with workarounds
  </done>
</task>

<task type="auto">
  <name>Add Log File Not Growing section</name>
  <files>docs/TROUBLESHOOTING.md</files>
  <action>
    Append the Log File Not Growing section after Multi-Process Limitations:

    ```markdown
    ## Log File Not Growing

    ### Symptoms

    - Log file exists but no new entries
    - Application logs work in console but not file
    - No errors reported

    ### Diagnostic Steps

    1. Check if file transport is configured:
       ```typescript
       console.log(require('log-vibe').getConfig());
       ```

    2. Check file permissions:
       ```bash
       ls -la /path/to/logs/app.log
       ```

    3. Monitor file for changes:
       ```bash
       tail -f /path/to/logs/app.log
       ```

    ### Solutions

    **Verify configuration:**
    ```typescript
    import { configure } from 'log-vibe';

    configure({
      file: './logs/app.log',  // Make sure this is set
      console: false           // Ensure file logging is enabled
    });
    ```

    **Check error events:**
    ```typescript
    import { FileTransport } from 'log-vibe';

    const transport = new FileTransport('./logs/app.log');
    transport.on('error', (err) => {
      console.error('Transport error:', err);
    });

    configure({ transports: [transport] });
    ```
    ```
  </action>
  <verify>
    grep -q "Log File Not Growing" docs/TROUBLESHOOTING.md
  </verify>
  <done>
    Log file not growing issue documented with diagnostic steps
  </done>
</task>

<task type="auto">
  <name>Add Rotation Not Working section</name>
  <files>docs/TROUBLESHOOTING.md</files>
  <action>
    Append the Rotation Not Working section after Log File Not Growing:

    ```markdown
    ## Rotation Not Working

    ### Symptoms

    - Log file grows beyond maxSize
    - No rotated files created
    - Daily rotation doesn't occur

    ### Diagnostic Steps

    1. Verify rotation config:
       ```bash
       grep -A 5 "rotation:" config.js
       ```

    2. Check current file size:
       ```bash
       ls -lh /path/to/logs/app.log
       ```

    3. Look for rotated files:
       ```bash
       ls -lh /path/to/logs/app-*.log.*
       ```

    ### Solutions

    **Enable rotation:**
    ```typescript
    configure({
      file: './logs/app.log',
      rotation: {
        maxSize: '100MB',    // Size-based
        pattern: 'daily'     // Time-based
      }
    });
    ```

    **Check size format:**
    - Valid: `'100MB'`, `'1.5GB'`, `104857600` (bytes)
    - Invalid: `'100'` (needs unit), `'100 mb'` (no space)

    **Verify rotation isn't blocked by errors:**
    - Check console for rotation errors
    - Listen for 'error' events on transport
    - Ensure disk isn't full (rotation requires disk space)
    ```
  </action>
  <verify>
    grep -q "Rotation Not Working" docs/TROUBLESHOOTING.md
  </verify>
  <done>
    Rotation not working documented with solutions
  </done>
</task>

<task type="auto">
  <name>Add Compression Failures and Getting Help sections</name>
  <files>docs/TROUBLESHOOTING.md</files>
  <action>
    Append the Compression Failures and Getting Help sections at the end:

    ```markdown
    ## Compression Failures

    ### Symptoms

    - Rotated files not compressed
    - `.gz` files don't exist
    - Files in `failed/` subdirectory

    ### Diagnostic Steps

    1. Check for failed files:
       ```bash
       ls -lh /path/to/logs/failed/
       ```

    2. Check compression config:
       ```typescript
       console.log(require('log-vibe').getConfig());
       ```

    ### Solutions

    **Enable compression:**
    ```typescript
    configure({
      file: './logs/app.log',
      rotation: {
        maxSize: '100MB',
        compressionLevel: 6  // 1-9, default 6
      }
    });
    ```

    **Valid compression levels:**
    - 1: Fastest, larger files
    - 6: Balanced (recommended)
    - 9: Slowest, smallest files

    **Handle failed compression:**
    - Check disk space (compression needs temporary space)
    - Review files in `failed/` directory
    - Manually compress failed files:
      ```bash
      gzip /path/to/logs/failed/app-2025-01-18.log.1
      mv /path/to/logs/failed/app-2025-01-18.log.1.gz /path/to/logs/
      ```

    ## Getting Help

    If you're still experiencing issues:

    1. Check console.error output for detailed error messages
    2. Listen for 'error' events on transports
    3. Enable debug logging to see internal operations
    4. Review this troubleshooting guide
    5. Check GitHub issues: https://github.com/dustinober1/vibe-log/issues
    6. Create a new issue with:
       - log-vibe version
       - Node.js version
       - Operating system
       - Error messages
       - Minimal reproduction code

    ---

    *See also: [Monitoring Guide](./MONITORING.md)*
    ```
  </action>
  <verify>
    grep -q "Compression Failures" docs/TROUBLESHOOTING.md && grep -q "Getting Help" docs/TROUBLESHOOTING.md && grep -q "MONITORING.md" docs/TROUBLESHOOTING.md
  </verify>
  <done>
    Compression failures documented and Getting Help section with GitHub link added
  </done>
</task>

</tasks>

<verification>
- docs/TROUBLESHOOTING.md exists
- ENOSPC (disk full) error documented with symptoms, diagnostic steps, and solutions
- EACCES (permission denied) error documented with solutions
- Directory deletion issues documented
- Multi-process limitation clearly documented with workarounds
- Log file not growing documented
- Rotation not working documented
- Compression failures documented
- Getting help section included with GitHub link
- Cross-reference to MONITORING.md included
</verification>

<success_criteria>
- All common production errors covered
- Clear diagnostic steps provided
- Actionable solutions for each error type
- Multi-process limitation prominently documented
- Cross-reference to MONITORING.md (to be created in plan 06-05)
</success_criteria>

<output>
After completion, create `.planning/phases/06-error-handling-hardening/06-04-SUMMARY.md`
</output>
