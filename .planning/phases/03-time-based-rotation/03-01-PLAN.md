---
phase: 03-time-based-rotation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types.ts
  - src/utils/rotation.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can configure daily rotation pattern via configure({ file, rotation: { pattern: 'daily' } })"
    - "RotationConfig accepts pattern field with 'daily' value"
    - "Midnight rotation occurs at correct UTC time regardless of server timezone"
    - "Rotation works correctly across month/year boundaries"
  artifacts:
    - path: "src/types.ts"
      provides: "RotationConfig interface with pattern field"
      contains: "pattern?: 'daily'"
    - path: "src/utils/rotation.ts"
      provides: "getMsUntilNextMidnightUTC utility function"
      exports: ["getMsUntilNextMidnightUTC"]
      min_lines: 30
  key_links:
    - from: "src/types.ts"
      to: "src/utils/rotation.ts"
      via: "type import"
      pattern: "import.*getMsUntilNextMidnightUTC"
---

<objective>
Add time-based rotation configuration and midnight calculation utility to enable daily log rotation scheduling.

Purpose: Extend RotationConfig to support daily rotation pattern and provide accurate UTC midnight calculation for timer scheduling. This foundational work enables FileTransport to schedule rotation at midnight without timezone issues.

Output: Extended RotationConfig interface with pattern field, and getMsUntilNextMidnightUTC utility function that calculates milliseconds until next UTC midnight.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-time-based-rotation/03-RESEARCH.md

@src/types.ts
@src/transports/file-transport.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend RotationConfig with pattern field</name>
  <files>src/types.ts</files>
  <action>
    Extend RotationConfig interface to add pattern field for daily rotation:

    1. Add `pattern?: 'daily'` field to RotationConfig interface
    2. Add JSDoc comment explaining pattern configures daily rotation at midnight UTC
    3. Document that pattern can be combined with maxSize for hybrid rotation

    Pattern should be optional to maintain backward compatibility (no pattern = no time-based rotation).

    Reference existing RotationConfig structure in src/types.ts (lines 29-32).
  </action>
  <verify>
    grep -n "pattern.*daily" src/types.ts returns field definition
  </verify>
  <done>
    RotationConfig interface has pattern?: 'daily' field with JSDoc documentation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create getMsUntilNextMidnightUTC utility function</name>
  <files>src/utils/rotation.ts</files>
  <action>
    Create new file src/utils/rotation.ts with getMsUntilNextMidnightUTC function:

    Function signature:
    ```typescript
    export function getMsUntilNextMidnightUTC(): number
    ```

    Implementation (from research):
    1. Get current UTC time using Date methods
    2. Calculate tomorrow midnight UTC using Date.UTC()
    3. Return difference in milliseconds

    Key implementation details:
    - Use Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + 1, 0, 0, 0, 0)
    - Use now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), now.getUTCHours(), etc. for current time
    - Return tomorrowMidnight - now (in milliseconds)

    Handle edge cases:
    - End of month: getUTCDate() + 1 automatically rolls over
    - End of year: getUTCMonth() + 1 rolls over, getUTCFullYear() increments
    - Year transitions: Date.UTC handles all transitions correctly

    Add JSDoc with example usage and UTC rationale (avoids DST issues).

    Research reference: 03-RESEARCH.md Pattern 1 (Midnight Calculation with UTC)
  </action>
  <verify>
    grep -n "getMsUntilNextMidnightUTC" src/utils/rotation.ts returns function definition
    grep -n "Date.UTC" src/utils/rotation.ts returns UTC calculation
  </verify>
  <done>
    src/utils/rotation.ts exists with getMsUntilNextMidnightUTC function that returns milliseconds until next UTC midnight
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation succeeds with no errors
2. RotationConfig interface in src/types.ts has pattern?: 'daily' field
3. src/utils/rotation.ts exports getMsUntilNextMidnightUTC function
4. Function correctly calculates midnight UTC (manual test: returns value between 0 and 86400000)
</verification>

<success_criteria>
1. RotationConfig extended with pattern field for daily rotation configuration
2. getMsUntilNextMidnightUTC utility function accurately calculates milliseconds until next UTC midnight
3. Code is well-documented with JSDoc comments
4. No breaking changes to existing RotationConfig usage (pattern is optional)
</success_criteria>

<output>
After completion, create `.planning/phases/03-time-based-rotation/03-01-SUMMARY.md`
</output>
