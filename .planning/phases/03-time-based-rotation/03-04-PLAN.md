---
phase: 03-time-based-rotation
plan: 04
type: execute
wave: 4
depends_on: [03-03]
files_modified:
  - src/config.ts
  - test/config.test.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can configure daily rotation via configure({ file, rotation: { pattern: 'daily' } })"
    - "configure() passes pattern to FileTransport constructor"
    - "TypeScript types support pattern field in rotation config"
    - "Existing rotation config (maxSize) continues to work unchanged"
    - "Rotated files use date-stamped names like app-2026-01-18.log (FILE-01)"
    - "Active file maintains base name like app.log after rotation (FILE-02)"
  artifacts:
    - path: "src/config.ts"
      provides: "Rotation config integration in configure()"
      contains: "pattern field handling"
    - path: "test/config.test.ts"
      provides: "Tests for rotation config with pattern field"
      contains: "pattern: 'daily' test case"
      contains: "date-stamped filename verification"
      contains: "active file base name verification"
  key_links:
    - from: "configure()"
      to: "FileTransport constructor"
      via: "rotation config passing"
      pattern: "new FileTransport.*rotation"
    - from: "configure()"
      to: "RotationConfig type"
      via: "type checking"
      pattern: "rotation.*RotationConfig"
    - from: "test/config.test.ts"
      to: "src/utils/rotation.ts"
      via: "generateRotatedName import and verification"
      pattern: "import.*generateRotatedName|generateRotatedName.*test"
---

<objective>
Integrate time-based rotation configuration into public API via configure() function with explicit verification of date-stamped filenames.

Purpose: Enable users to configure daily rotation pattern using the public configure() API. Ensure pattern field is correctly passed to FileTransport constructor and maintain backward compatibility with existing rotation configuration (maxSize). Verify that Phase 2's generateRotatedName utility produces date-stamped filenames (FILE-01) and that the active file maintains its base name after rotation (FILE-02).

Output: configure() function supports pattern field in rotation config, with comprehensive tests verifying date-stamped filenames, active file base name behavior, and backward compatibility maintained.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-time-based-rotation/03-01-SUMMARY.md
@.planning/phases/03-time-based-rotation/03-02-SUMMARY.md
@.planning/phases/03-time-based-rotation/03-03-SUMMARY.md
@.planning/phases/02-core-rotation-infrastructure/02-05-SUMMARY.md

@src/config.ts
@src/types.ts
@src/transports/file-transport.ts
@src/utils/rotation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update configure() to pass pattern to FileTransport</name>
  <files>src/config.ts</files>
  <action>
    Review current configure() implementation to understand how rotation config is passed to FileTransport.

    Update file shorthand handling in configure() function:
    1. Find the section where file shorthand is processed (look for `new FileTransport`)
    2. Ensure rotation config (including pattern field) is passed to FileTransport constructor
    3. Pattern should be passed in options parameter: `{ pattern: rotation.pattern, maxSize: rotation.maxSize }`

    Implementation approach:
    - If rotation.pattern exists, pass it in FileTransport options
    - If rotation.maxSize exists, pass it in FileTransport options
    - Both fields should be passed if present (hybrid rotation)

    Reference existing rotation config handling (should already pass maxSize).
    Add pattern field to the options object being passed.

    The code should look like:
    ```typescript
    const fileTransport = new FileTransport(file, {
        maxSize: rotation?.maxSize,
        pattern: rotation?.pattern
    });
    ```

    Ensure backward compatibility: if rotation is undefined, don't pass any options.
  </action>
  <verify>
    grep -A 5 "new FileTransport" src/config.ts | grep -q "pattern"
  </verify>
  <done>
    configure() passes pattern field to FileTransport constructor when provided
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for pattern configuration</name>
  <files>test/config.test.ts</files>
  <action>
    Add test cases to test/config.test.ts for pattern configuration:

    Test cases to add:

    1. Test daily pattern configuration:
       ```typescript
       it('should configure daily rotation pattern', () => {
           configure({
               file: './test-logs/config-daily.log',
               rotation: { pattern: 'daily' }
           });

           // Verify FileTransport is created with daily pattern
           // (This may require accessing internal state or checking transport creation)
       });
       ```

    2. Test hybrid rotation (pattern + maxSize):
       ```typescript
       it('should configure hybrid rotation with pattern and maxSize', () => {
           configure({
               file: './test-logs/config-hybrid.log',
               rotation: {
                   pattern: 'daily',
                   maxSize: '50MB'
               }
           });

           // Verify both options are passed
       });
       ```

    3. Test backward compatibility (maxSize only):
       ```typescript
       it('should continue to support maxSize-only rotation config', () => {
           configure({
               file: './test-logs/config-size.log',
               rotation: { maxSize: '100MB' }
           });

           // Verify existing config still works
       });
       ```

    4. Test no rotation (backward compatibility):
       ```typescript
       it('should create file transport without rotation when not configured', () => {
           configure({
               file: './test-logs/config-no-rotation.log'
           });

           // Verify file logging works without rotation
       });
       ```

    Note: Some tests may require accessing internal FileTransport state or using test helpers.
    Focus on verifying configure() doesn't throw errors and creates valid transports.

    Run `npm test` to verify all tests pass.
  </action>
  <verify>
    npm test 2>&1 | grep -q "passing"
    grep -n "pattern.*daily" test/config.test.ts returns test cases
  </verify>
  <done>
    Test coverage for pattern configuration in configure() function
  </done>
</task>

<task type="auto">
  <name>Task 3: Add verification tests for date-stamped filenames and active file base names</name>
  <files>test/config.test.ts</files>
  <action>
    Add explicit test cases to verify FILE-01 and FILE-02 requirements:

    Import Phase 2's generateRotatedName utility:
    ```typescript
    import { generateRotatedName } from '../src/utils/rotation';
    ```

    Test cases to add:

    1. Verify rotated files use date-stamped format (FILE-01):
       ```typescript
       it('should generate date-stamped filenames for rotated files (FILE-01)', () => {
           const baseName = './test-logs/app.log';
           const rotationDate = new Date('2026-01-18T00:00:00Z');

           const rotatedName = generateRotatedName(baseName, rotationDate);

           // Verify format: app-2026-01-18.log
           expect(rotatedName).toMatch(/app-2026-01-18\.log$/);
           expect(rotatedName).not.toBe(baseName); // Rotated name is different from active
       });
       ```

    2. Verify active file maintains base name after rotation (FILE-02):
       ```typescript
       it('should maintain active file base name after rotation (FILE-02)', async () => {
           const testFile = './test-logs/active-test.log';
           const testDir = './test-logs';

           // Configure with daily rotation
           configure({
               file: testFile,
               rotation: { pattern: 'daily' }
           });

           // Write initial log
           const logger = new Logger('test');
           logger.info('before rotation');

           // Force rotation by advancing time and triggering check
           // (This may require using Vitest fake timers or manual rotation trigger)

           // After rotation, verify new active file has base name
           const filesAfterRotation = fs.readdirSync(testDir).filter(f => f.includes('active-test'));
           const activeFile = filesAfterRotation.find(f => f === 'active-test.log');

           expect(activeFile).toBeDefined();
           expect(activeFile).toBe('active-test.log'); // Base name maintained
       });
       ```

    3. Verify date format across month/year boundaries:
       ```typescript
       it('should handle date-stamped names across month boundaries', () => {
           const baseName = './test-logs/app.log';
           const jan31 = new Date('2026-01-31T23:59:59Z');
           const feb1 = new Date('2026-02-01T00:00:01Z');

           const rotatedJan = generateRotatedName(baseName, jan31);
           const rotatedFeb = generateRotatedName(baseName, feb1);

           expect(rotatedJan).toMatch(/app-2026-01-31\.log$/);
           expect(rotatedFeb).toMatch(/app-2026-02-01\.log$/);
       });
       ```

    Run `npm test` to verify all tests pass.
  </action>
  <verify>
    npm test 2>&1 | grep -q "passing"
    grep -n "FILE-01\|FILE-02\|date-stamped\|base name" test/config.test.ts returns verification tests
  </verify>
  <done>
    Explicit verification that rotated files use date-stamped names (FILE-01) and active file maintains base name (FILE-02)
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation succeeds with no errors
2. configure() accepts pattern field in rotation config
3. Pattern is correctly passed to FileTransport constructor
4. Existing rotation config (maxSize only) continues to work
5. Rotated files use date-stamped format app-YYYY-MM-DD.log (FILE-01 verified)
6. Active file maintains base name like app.log after rotation (FILE-02 verified)
7. All tests pass (npm test shows 100% passing)
</verification>

<success_criteria>
1. Users can configure daily rotation via configure({ file, rotation: { pattern: 'daily' } })
2. Pattern field is integrated into public API
3. Backward compatibility maintained (existing rotation configs unchanged)
4. Tests verify configuration integration
5. Tests verify date-stamped filenames (FILE-01 requirement)
6. Tests verify active file base name behavior (FILE-02 requirement)
</success_criteria>

<output>
After completion, create `.planning/phases/03-time-based-rotation/03-04-SUMMARY.md`
</output>
